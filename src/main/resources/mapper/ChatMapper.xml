<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spaceobj.spaceobj.mapper.ChatMapper">
    
    <!-- 插入消息 -->
    <insert id="insertMessage" parameterType="com.spaceobj.spaceobj.pojo.ChatMessage">
        INSERT INTO chat_messages (message_type, sender_id, target_id, group_id, content, sent_at)
        VALUES (#{messageType}, #{senderId}, #{targetId}, #{groupId}, #{content}, #{sentAt})
    </insert>
    
    <!-- 查询私聊消息 -->
    <select id="getPrivateMessages" resultType="com.spaceobj.spaceobj.pojo.ChatMessage">
        SELECT m.*, CONCAT(COALESCE(s.first_name, ''), COALESCE(s.last_name, '')) as senderName
        FROM chat_messages m
        LEFT JOIN students s ON m.sender_id = s.student_id
        WHERE m.message_type = 'PRIVATE'
          AND ((m.sender_id = #{userId1} AND m.target_id = #{userId2})
               OR (m.sender_id = #{userId2} AND m.target_id = #{userId1}))
        ORDER BY m.sent_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    
    <!-- 查询群聊消息 -->
    <select id="getGroupMessages" resultType="com.spaceobj.spaceobj.pojo.ChatMessage">
        SELECT m.*, CONCAT(COALESCE(s.first_name, ''), COALESCE(s.last_name, '')) as senderName
        FROM chat_messages m
        LEFT JOIN students s ON m.sender_id = s.student_id
        WHERE m.message_type = 'GROUP' AND m.group_id = #{groupId}
        ORDER BY m.sent_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    
    <!-- 插入群成员 -->
    <insert id="insertGroupMember" parameterType="com.spaceobj.spaceobj.pojo.GroupMember">
        INSERT INTO group_members (group_id, student_id, joined_at)
        VALUES (#{groupId}, #{studentId}, #{joinedAt})
    </insert>
    
    <!-- 删除群成员 -->
    <delete id="deleteGroupMember">
        DELETE FROM group_members 
        WHERE group_id = #{groupId} AND student_id = #{studentId}
    </delete>
    
    <!-- 检查是否是群成员 -->
    <select id="isGroupMember" resultType="boolean">
        SELECT COUNT(*) > 0 
        FROM group_members 
        WHERE group_id = #{groupId} AND student_id = #{studentId}
    </select>
    
    <!-- 获取用户加入的所有群组 -->
    <select id="getUserGroups" resultType="String">
        SELECT group_id 
        FROM group_members 
        WHERE student_id = #{studentId}
    </select>
    
    <!-- 获取群组成员 -->
    <select id="getGroupMembers" resultType="com.spaceobj.spaceobj.pojo.GroupMember">
        SELECT gm.*, CONCAT(COALESCE(s.first_name, ''), COALESCE(s.last_name, '')) as studentName
        FROM group_members gm
        LEFT JOIN students s ON gm.student_id = s.student_id
        WHERE gm.group_id = #{groupId}
        ORDER BY gm.joined_at
    </select>
    
    <!-- 获取所有群组ID列表 -->
    <select id="getAllGroups" resultType="String">
        SELECT DISTINCT group_id 
        FROM group_members 
        ORDER BY group_id
    </select>
    
</mapper> 